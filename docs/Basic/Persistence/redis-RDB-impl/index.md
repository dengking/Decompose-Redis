# Redis  RDB implementation



## zhihu [Redis 持久化 RDB 原理](https://zhuanlan.zhihu.com/p/345233479)



### 四. RDB 原理

我们看下RDB过程中监控下系统调用情况：

```java
[root@localhost 7000]# ps -ef |grep redis
root       371  5245  0 14:15 pts/1    00:00:00 grep --color=auto redis
root     30969     1  1 13:42 ?        00:00:25 redis-server 0.0.0.0:7000
root     31617  5434  0 13:55 pts/2    00:00:00 redis-cli -p 7000

[root@localhost 7000]# strace -tt -f -o output.log -p 30969
```

strace命令会把 redis-server进程执行的系统调用给输出到output.log 中，然后我们在执行save命令，观察输出：

```java
30969 14:05:43.842462 read(8, "*1\r\n$4\r\nsave\r\n", 16384) = 14
30969 14:05:43.842663 open("temp-30969.rdb", O_WRONLY|O_CREAT|O_TRUNC, 0666) = 10
30969 14:05:43.842955 fstat(10, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0
30969 14:05:43.843127 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f7f74a25000
30969 14:05:43.843457 write(10, "REDIS0008\372\tredis-ver\0064.0.10\372\nred"..., 4096) = 4096
30969 14:05:43.843848 write(10, "127.1711.1781.2321\303\22D\21\1AA\340\377\0\340\377\0\340"..., 4096) = 4096
30969 14:05:43.844230 write(10, "\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377"..., 4096) = 4096
30969 14:05:43.844547 write(10, "\340 \0\1AA\0\020127.231"..., 4096) = 4096
30969 14:05:43.844894 write(10, "71.721\303\fA\204\1AA\340\377\0\340o\0\1AA\0\020127.1691"..., 4096) = 4096
30969 14:05:43.845259 write(10, "\36GS\1AA\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0\340\16\0\1A"..., 4096) = 4096
30969 14:05:43.845591 write(10, ".1251.1801\303\36Gf\1AA\340\377\0\340\377\0\340\377\0\340\377\0\340\377\0"..., 4096) = 4096
....
....
30969 14:05:45.271929 fsync(10)         = 0
30969 14:05:45.372375 close(10)         = 0
30969 14:05:45.372606 munmap(0x7f7f74a25000, 4096) = 0
30969 14:05:45.372821 rename("temp-30969.rdb", "7000_dump.rdb") = 0
30969 14:05:45.373023 open("/usr/local/app/redis-cluster/7000/redis.log", O_WRONLY|O_CREAT|O_APPEND, 0666) = 10
30969 14:05:45.373221 lseek(10, 0, SEEK_END) = 1117342
30969 14:05:45.373381 stat("/etc/localtime", {st_mode=S_IFREG|0644, st_size=528, ...}) = 0
30969 14:05:45.373665 fstat(10, {st_mode=S_IFREG|0644, st_size=1117342, ...}) = 0
30969 14:05:45.373819 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f7f74a25000
30969 14:05:45.374029 write(10, "30969:M 20 Jan 14:05:45.373 * DB"..., 47) = 47
30969 14:05:45.374196 close(10)         = 0
30969 14:05:45.374363 munmap(0x7f7f74a25000, 4096) = 0
```

从上面日志我们分析save执行RDB的几个重要的步骤：

1. read save : 读入save命令 。
2. open temp-30969.rdb ： 打开一个临时文件。
3. fstat ： 获取临时文件的详细信息。
4. mmap ： 将进程的一段地址 映射到 文件上，这样直接改进程的内存就直接反映到文件上了。
5. write ： 写redis数据到临时文件，每次写4096个字节**（4KB）**。
6. fsync ： 将上面write的数据实际写入磁盘， 这个 **fsync 需要好好讲一讲。下面会有介绍。**
7. close ： 关闭文件。
8. 将步骤4的 映射解除。
9. rename ： 重命名临时文件为 你指定的RDB文件名称。
10. open ：写一些日志到日志文件。发现写的内容是 30969:M 20 Jan 14:05:45.373 * DB...